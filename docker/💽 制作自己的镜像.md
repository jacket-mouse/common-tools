# ğŸ’½ åˆ¶ä½œè‡ªå·±çš„é•œåƒ

### ä¸ºè‡ªå·±çš„ Web é¡¹ç›®æ„å»ºé•œåƒ

ç¤ºä¾‹é¡¹ç›®ä»£ç ï¼šhttps://github.com/gzyunke/test-docker
è¿™æ˜¯ä¸€ä¸ª Nodejs + Koa2 å†™çš„ Web é¡¹ç›®ï¼Œæä¾›äº†ç®€å•çš„ä¸¤ä¸ªæ¼”ç¤ºé¡µé¢ã€‚
è½¯ä»¶ä¾èµ–ï¼š[nodejs](https://nodejs.org/zh-cn/)
é¡¹ç›®ä¾èµ–åº“ï¼škoaã€log4jsã€koa-router

> æœ¬æ–‡æ¡£è¯¾ä»¶é…å¥— [è§†é¢‘æ•™ç¨‹](https://www.bilibili.com/video/BV11L411g7U1?p=3)

### ç¼–å†™ Dockerfile

```
FROM node:11
MAINTAINER easydoc.net

# å¤åˆ¶ä»£ç 
ADD . /app

# è®¾ç½®å®¹å™¨å¯åŠ¨åçš„é»˜è®¤è¿è¡Œç›®å½•
WORKDIR /app

# è¿è¡Œå‘½ä»¤ï¼Œå®‰è£…ä¾èµ–
# RUN å‘½ä»¤å¯ä»¥æœ‰å¤šä¸ªï¼Œä½†æ˜¯å¯ä»¥ç”¨ && è¿æ¥å¤šä¸ªå‘½ä»¤æ¥å‡å°‘å±‚çº§ã€‚
# ä¾‹å¦‚ RUN npm install && cd /app && mkdir logs
RUN npm install --registry=https://registry.npm.taobao.org

# CMD æŒ‡ä»¤åªèƒ½ä¸€ä¸ªï¼Œæ˜¯å®¹å™¨å¯åŠ¨åæ‰§è¡Œçš„å‘½ä»¤ï¼Œç®—æ˜¯ç¨‹åºçš„å…¥å£ã€‚
# å¦‚æœè¿˜éœ€è¦è¿è¡Œå…¶ä»–å‘½ä»¤å¯ä»¥ç”¨ && è¿æ¥ï¼Œä¹Ÿå¯ä»¥å†™æˆä¸€ä¸ªshellè„šæœ¬å»æ‰§è¡Œã€‚
# ä¾‹å¦‚ CMD cd /app && ./start.sh
CMD node app.js
```

[Dockerfileæ–‡æ¡£](https://docs.docker.com/engine/reference/builder/#run)

> å®ç”¨æŠ€å·§ï¼š
> å¦‚æœä½ å†™ Dockerfile æ—¶ç»å¸¸é‡åˆ°ä¸€äº›è¿è¡Œé”™è¯¯ï¼Œä¾èµ–é”™è¯¯ç­‰ï¼Œä½ å¯ä»¥ç›´æ¥è¿è¡Œä¸€ä¸ªä¾èµ–çš„åº•ï¼Œç„¶åè¿›å…¥ç»ˆç«¯è¿›è¡Œé…ç½®ç¯å¢ƒï¼ŒæˆåŠŸåå†æŠŠåšè¿‡çš„æ­¥éª¤å‘½ä»¤å†™é“ Dockerfile æ–‡ä»¶ä¸­ï¼Œè¿™æ ·ç¼–å†™è°ƒè¯•ä¼šå¿«å¾ˆå¤šã€‚
> ä¾‹å¦‚ä¸Šé¢çš„åº•æ˜¯`node:11`ï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œ`docker run -it -d node:11 bash`ï¼Œè·‘èµ·æ¥åè¿›å…¥å®¹å™¨ç»ˆç«¯é…ç½®ä¾èµ–çš„è½¯ä»¶ï¼Œç„¶åå°è¯•è·‘èµ·æ¥è‡ªå·±çš„è½¯ä»¶ï¼Œæœ€åæŠŠæ‰€æœ‰åšè¿‡çš„æ­¥éª¤å†™å…¥åˆ° Dockerfile å°±å¥½äº†ã€‚
> æŒæ¡å¥½è¿™ä¸ªæŠ€å·§ï¼Œä½ çš„ Dockerfile æ–‡ä»¶ç¼–å†™èµ·æ¥å°±éå¸¸çš„å¾—å¿ƒåº”æ‰‹äº†ã€‚

### Build ä¸ºé•œåƒï¼ˆå®‰è£…åŒ…ï¼‰å’Œè¿è¡Œ

ç¼–è¯‘ `docker build -t test:v1 .`

> `-t` è®¾ç½®é•œåƒåå­—å’Œç‰ˆæœ¬å·
> å‘½ä»¤å‚è€ƒï¼šhttps://docs.docker.com/engine/reference/commandline/build/

è¿è¡Œ `docker run -p 8080:8080 --name test-hello test:v1`

> `-p` æ˜ å°„å®¹å™¨å†…ç«¯å£åˆ°å®¿ä¸»æœº
> `--name` å®¹å™¨åå­—
> `-d` åå°è¿è¡Œ
> å‘½ä»¤å‚è€ƒæ–‡æ¡£ï¼šhttps://docs.docker.com/engine/reference/run/

### æ›´å¤šç›¸å…³å‘½ä»¤

`docker ps` æŸ¥çœ‹å½“å‰è¿è¡Œä¸­çš„å®¹å™¨
`docker images` æŸ¥çœ‹é•œåƒåˆ—è¡¨
`docker rm container-id` åˆ é™¤æŒ‡å®š id çš„å®¹å™¨
`docker stop/start container-id` åœæ­¢/å¯åŠ¨æŒ‡å®š id çš„å®¹å™¨
`docker rmi image-id` åˆ é™¤æŒ‡å®š id çš„é•œåƒ
`docker volume ls` æŸ¥çœ‹ volume åˆ—è¡¨
`docker network ls` æŸ¥çœ‹ç½‘ç»œåˆ—è¡¨

> è§‰å¾—è€å¸ˆè®²å¾—ä¸é”™çš„è¯ï¼Œè®°å¾—ç‚¹èµã€å…³æ³¨ã€åˆ†äº«ï¼Œé¼“åŠ±ä¸‹è€å¸ˆ
> ä½ ä»¬çš„é¼“åŠ±ä¼šè®©è€å¸ˆæ›´åŠ æœ‰åŠ¨åŠ›ç»§ç»­åˆ›é€ æ›´å¤šæ›´å¥½çš„å†…å®¹

ä½ å¯ä»¥åˆ° [Github issue](https://github.com/gzyunke/test-docker/issues) ç»™æˆ‘æé—®æˆ–åé¦ˆé‡åˆ°çš„é—®é¢˜ã€‚

### å®æˆ˜ï¼šç¤¾å·¥åº“é¡¹ç›®(SED)æ‰“åŒ…

```dockerfile
# ä½¿ç”¨å¤šé˜¶æ®µæ„å»º
# ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºå‰ç«¯åº”ç”¨
FROM node:18 AS frontend
WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm install
COPY frontend/ .
RUN npm run build

# ç¬¬äºŒé˜¶æ®µï¼šæ„å»ºåç«¯åº”ç”¨
FROM python:3.12 AS backend
WORKDIR /app/backend
COPY backend/requirements.txt ./
RUN pip install -r requirements.txt
COPY backend/ .

# å°†å‰ç«¯æ„å»ºç»“æœå¤åˆ¶åˆ°åç«¯é™æ€æ–‡ä»¶ç›®å½•
COPY --from=frontend /app/frontend/dist /app/backend/static

# è®¾ç½®å¯åŠ¨å‘½ä»¤
CMD ["python", "app.py"]

```

é¦–å…ˆï¼Œå…ˆäººå·¥æ‰“åŒ…éªŒè¯ä¸€ä¸‹æµç¨‹èƒ½å¦æ­£å¸¸è¿ä½œã€‚

å‰ç«¯æ˜¯Vueï¼Œä½¿ç”¨`npm run build`è¿›è¡Œæ‰“åŒ…ï¼Œæ‰“åŒ…åçš„æ–‡ä»¶åœ¨`dist`æ–‡ä»¶å¤¹ä¸‹ï¼ŒåŒ…æ‹¬`index.html`å’Œ`assets`é‡Œçš„CSSã€JSæ–‡ä»¶ï¼Œå°†å…¶å¤åˆ¶åˆ°åç«¯æ ¹ç›®å½•ä¸‹çš„`static`æ–‡ä»¶å¤¹ä¸‹å°±å¯ä»¥äº†ã€‚

#### æ³¨æ„ç‚¹âš ï¸ï¼š

```shell
src/main.ts:3:17 - error TS7016: Could not find a declaration file for module './App.vue'. '/Users/leeson/Documents/SED/frontend/src/App.vue' implicitly has an 'any' type.

3 import App from './App.vue'
                  ~~~~~~~~~~~

Found 1 error.
```

#### TypeScript æ— æ³•æ‰¾åˆ° `App.vue` çš„ç±»å‹å£°æ˜æ–‡ä»¶ã€‚

åœ¨é¡¹ç›®çš„ `src` ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `shims-vue.d.ts` æ–‡ä»¶ï¼ˆå¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œç¡®ä¿å†…å®¹æ­£ç¡®ï¼‰ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```typescript
// src/shims-vue.d.ts
declare module '*.vue' {
  import { DefineComponent } from 'vue'
  const component: DefineComponent<{}, {}, any>
  export default component
}
```

è¿™ä¸ªæ–‡ä»¶å‘Šè¯‰ TypeScript ä»»ä½• `.vue` æ–‡ä»¶éƒ½åº”è¯¥è¢«è§†ä¸º `DefineComponent` ç±»å‹ï¼Œä»è€Œè§£å†³ç±»å‹é”™è¯¯ã€‚

------

```typescript
// vite.config.ts
// https://vite.dev/config/
export default defineConfig({
  plugins: [vue()],
  base: './',
})
```

#### åœ¨å‰ç«¯é¡¹ç›®ä¸­ï¼Œç¡®ä¿ `vite.config.js`ï¼ˆæˆ– Webpack çš„é…ç½®æ–‡ä»¶ï¼‰æ­£ç¡®é…ç½®äº† `base` è·¯å¾„ã€‚

------

#### **å‰ç«¯æµ‹è¯•æ‰“åŒ…åçš„é¡¹ç›®**

å¯ä»¥ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨æµ‹è¯•æ‰“åŒ…åçš„æ–‡ä»¶ï¼Œä»¥ç¡®ä¿æ‰€æœ‰èµ„æºåŠ è½½æ­£å¸¸ã€‚

ä¾‹å¦‚ï¼Œä½¿ç”¨ `serve` åŒ…ï¼š

```bash
npm install -g serve
serve -s dist
```

è¿™ä¼šåœ¨æœ¬åœ°å¯åŠ¨æœåŠ¡å™¨ï¼ˆé»˜è®¤ç«¯å£æ˜¯ 3000ï¼‰ï¼Œç„¶åå¯ä»¥åœ¨æµè§ˆå™¨ä¸­è®¿é—® `http://localhost:3000` è¿›è¡Œæµ‹è¯•ã€‚

------

flaskåç«¯é…ç½®

```python
from flask import Flask, request, jsonify, send_from_directory
from flask_cors import CORS
import parser
import os
import es
import preprocess
import mysql

app = Flask(__name__, static_folder="static") # å‰ç«¯æ–‡ä»¶å¤¹
CORS(app, resources={r"/*": {"origins": ["http://127.0.0.1:5000", "http://localhost:5000"]}}) # è·¨åŸŸé—®é¢˜


@app.route("/")
def serve_frontend():
    # æ¸²æŸ“ static ç›®å½•ä¸‹çš„ index.html æ–‡ä»¶
    return send_from_directory(app.static_folder, "index.html")

@app.route("/", defaults={"path": ""})
@app.route("/<path:path>")
# å¦‚æœå‰ç«¯ä½¿ç”¨äº†è·¯ç”±ï¼ˆå¦‚ Vue Router çš„ history æ¨¡å¼ï¼‰ï¼Œåˆ·æ–°é¡µé¢æ—¶å¯èƒ½ä¼šå‡ºç° 404 é”™è¯¯ã€‚ä½ å¯ä»¥æ·»åŠ ä¸€ä¸ªé€šé…ç¬¦è·¯ç”±æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œå°†æ‰€æœ‰æœªçŸ¥è·¯å¾„éƒ½æŒ‡å‘ index.htmlï¼š
def catch_all(path):
    return send_from_directory(app.static_folder, "index.html")

# é™æ€æ–‡ä»¶è·¯ç”± æ­¤ä»£ç ç¡®ä¿ /assets/ è·¯å¾„ä¸‹çš„æ–‡ä»¶éƒ½èƒ½æ­£ç¡®åŠ è½½ï¼Œä¸” MIME ç±»å‹æ­£ç¡®ã€‚
# [Error] TypeError: 'text/html' is not a valid JavaScript MIME type.
# [Error] Did not parse stylesheet at 'http://127.0.0.1:5000/assets/index-DUZdR4nK.css' because non CSS MIME types are not allowed in strict mode.
# è¿™äº›é”™è¯¯è¡¨æ˜ Flask è¿”å›çš„é™æ€æ–‡ä»¶çš„ MIME ç±»å‹ä¸æ­£ç¡®ã€‚æµè§ˆå™¨æœŸæœ› JavaScript å’Œ CSS æ–‡ä»¶å…·æœ‰ç‰¹å®šçš„ MIME ç±»å‹ (application/javascript å’Œ text/css)ï¼Œä½† Flask å½“å‰è¿”å›çš„ç±»å‹æ˜¯ text/htmlï¼Œå¯¼è‡´èµ„æºæœªè¢«æ­£ç¡®åŠ è½½ã€‚
@app.route("/assets/<path:filename>")
def serve_static(filename):
    return send_from_directory(app.static_folder + "/assets", filename)
```

------

#### å‰åç«¯é€šè®¯é—®é¢˜ï¼š`localhost` and `127.0.0.1`

ç¡®ä¿å‰ç«¯å’Œåç«¯éƒ½ä½¿ç”¨ç›¸åŒçš„ä¸»æœºåœ°å€å’Œç«¯å£ï¼ˆä¾‹å¦‚ï¼Œéƒ½æ˜¯ `127.0.0.1` æˆ–éƒ½æ˜¯ `localhost`ï¼‰ï¼Œå› ä¸ºæµè§ˆå™¨å°† `127.0.0.1` å’Œ `localhost` è§†ä¸ºä¸åŒçš„æ¥æºã€‚

æˆ‘è¿™ä¸ªé¡¹ç›®ï¼Œåç«¯åªæœ‰è¿è¡Œåœ¨`127.0.0.1`æ‰èƒ½æ­£å¸¸æ˜¾ç¤ºå‰æ®µç•Œé¢ï¼Œ`localhost`ä¸å¯ä»¥æ­£å¸¸æ˜¾ç¤ºã€‚

åœ¨å‰åç«¯é¡¹ç›®ä¸­ç»Ÿä¸€ `localhost` å’Œ `127.0.0.1`ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹æ³•æ¥ç¡®ä¿å‰åç«¯éƒ½ä½¿ç”¨ç›¸åŒçš„åœ°å€ã€‚

##### 1. é…ç½®ç¯å¢ƒå˜é‡ç»Ÿä¸€åœ°å€

ä½¿ç”¨ç¯å¢ƒå˜é‡æ¥è®¾ç½®å‰åç«¯çš„åœ°å€ï¼Œä¾‹å¦‚ä½¿ç”¨ `.env` æ–‡ä»¶æ¥ä¿å­˜ä¸»æœºå’Œç«¯å£é…ç½®ã€‚åœ¨å‰åç«¯åˆ†åˆ«è¯»å–ç›¸åŒçš„ç¯å¢ƒå˜é‡ï¼Œä»¥ç¡®ä¿ç»Ÿä¸€åœ°å€ã€‚

#### ç¤ºä¾‹

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º `.env` æ–‡ä»¶ï¼š

```plaintext
HOST=127.0.0.1
PORT=5000
```

ç„¶ååœ¨å‰ç«¯å’Œåç«¯éƒ½è¯»å–è¿™äº›å˜é‡ï¼š

- **åç«¯ï¼ˆFlask ç¤ºä¾‹ï¼‰**ï¼š

  ```python
  import os
  from flask import Flask
  from flask_cors import CORS
  from dotenv import load_dotenv

  load_dotenv()  # åŠ è½½ç¯å¢ƒå˜é‡

  app = Flask(__name__)
  CORS(app, resources={r"/*": {"origins": f"http://{os.getenv('HOST')}:{os.getenv('PORT')}"}})

  if __name__ == "__main__":
      app.run(host=os.getenv("HOST"), port=int(os.getenv("PORT")))
  ```

- **å‰ç«¯ï¼ˆVue ç¤ºä¾‹ï¼‰**ï¼š

  åœ¨ `vite.config.js` ä¸­ä½¿ç”¨ `dotenv` è¯»å–é…ç½®ï¼š

  ```javascript
  import { defineConfig } from 'vite';
  import vue from '@vitejs/plugin-vue';
  import dotenv from 'dotenv';
  
  dotenv.config(); // åŠ è½½ç¯å¢ƒå˜é‡
  
  export default defineConfig({
    plugins: [vue()],
    server: {
      host: process.env.HOST,   // ä»ç¯å¢ƒå˜é‡è¯»å–
      port: parseInt(process.env.PORT),
    }
  });
  ```

##### 2. ç»Ÿä¸€ä½¿ç”¨ `localhost` æˆ– `127.0.0.1`ï¼ˆæˆ‘ç”¨çš„æ˜¯è¿™ä¸ª

åœ¨å¼€å‘é˜¶æ®µï¼Œé€‰æ‹©ç»Ÿä¸€ä½¿ç”¨ `localhost` æˆ– `127.0.0.1`ï¼Œç¡®ä¿å‰ç«¯å’Œåç«¯ä»£ç ä¸€è‡´ã€‚

- **å‰ç«¯**ï¼šåœ¨ API è¯·æ±‚æ—¶ä½¿ç”¨å›ºå®šåœ°å€ã€‚ä¾‹å¦‚ï¼š

  ```javascript
  const apiBaseURL = "http://127.0.0.1:5000";  // æˆ– "http://localhost:5000"
  ```

- **åç«¯**ï¼šåœ¨ Flask ä¸­ä¹Ÿç»‘å®šåŒä¸€åœ°å€ã€‚ä¾‹å¦‚ï¼š

  ```python
  app.run(host="127.0.0.1", port=5000)  # æˆ– "localhost"
  ```

##### 3. ä½¿ç”¨ä»£ç†æœåŠ¡å™¨è§£å†³è·¨åŸŸ

å¦‚æœå‰ç«¯å’Œåç«¯ç«¯å£ä¸ä¸€è‡´ï¼Œå¯ä»¥åœ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨ä¸­è®¾ç½®ä»£ç†ã€‚ä»¥ Vite ä¸ºä¾‹ï¼Œå¯ä»¥åœ¨ `vite.config.js` ä¸­é…ç½®ä»£ç†ï¼Œå°† API è¯·æ±‚æŒ‡å‘åç«¯ã€‚

```javascript
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://127.0.0.1:5000', // åç«¯åœ°å€
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '') // æ ¹æ®éœ€è¦ä¿®æ”¹è·¯å¾„
      }
    }
  }
});
```

è¿™æ ·ï¼Œå‰ç«¯å¯ä»¥ç”¨ `/api` ä»£æ›¿ `127.0.0.1:5000`ï¼Œå®ç°å‰åç«¯ç»Ÿä¸€çš„åœ°å€é…ç½®ã€‚

------

ç»è¿‡ä¸Šè¿°çš„ä¿®æ”¹ï¼Œå‰åç«¯ç»ˆäºå¯ä»¥æ­£å¸¸äººå·¥æ‰“åŒ…ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥äº†ã€‚

è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š`docker build -t sed:v1 .`

ç¡®ä¿ï¼š

- Dockeråº”ç”¨å¼€å¯
- é•œåƒåç§°å…¨å°å†™

æœ‰æ—¶å€™ä¸‹è½½`python`å’Œ`node`ç­‰å®¹æ˜“è¶…æ—¶å¤±è´¥ï¼Œè¿™æ—¶å€™é…ç½®ä»£ç†å¯ä»¥è§£å†³è¯¥é—®é¢˜ã€‚

**Settings** > **Docker Engine**æ·»åŠ ä¸‹é¢è¯­å¥ï¼š

```json
"registry-mirrors": [
    "https://registry.cn-hangzhou.aliyuncs.com",
    "https://mirror.baidubce.com",
    "https://hub-mirror.c.163.com"
  ]
```

è¿è¡Œæµ‹è¯•æ–°çš„é•œåƒæºæ˜¯å¦èƒ½å¤Ÿæ­£ç¡®è¿æ¥ï¼Œå¹¶å°è¯•æ‰‹åŠ¨æ‹‰å–é•œåƒï¼Œç¡®ä¿æºå¯ç”¨ã€‚

```bash
docker pull python:3.12
docker pull node:18
```

Â æŒ‰ç…§ä¸Šè¿°æ­¥éª¤å¯åŠ¨é•œåƒã€‚